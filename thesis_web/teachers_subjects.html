<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Professor Subjects | ADV-Attendify</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            min-height: 100vh;
            overflow-x: hidden;
            background: url("images/backgroundhome.png") center/cover no-repeat fixed;
        }

        nav {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(8px);
            z-index: 1001;
        }

        .menu-btn {
            font-size: 28px;
            background: none;
            border: none;
            color: #6fe3ff;
            cursor: pointer;
        }

        .profile-wrapper {
            position: relative;
        }

        .profile {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid #6fe3ff;
        }

        .profile img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-menu {
            position: absolute;
            top: 55px;
            right: 0;
            background: #0b2a3a;
            border-radius: 12px;
            padding: 10px 0;
            min-width: 170px;
            opacity: 0;
            pointer-events: none;
            transition: 0.25s;
            z-index: 1002;
        }

        .profile-menu.active {
            opacity: 1;
            pointer-events: all;
        }

        .profile-menu a {
            display: block;
            padding: 12px 20px;
            color: #dffaff;
            text-decoration: none;
        }

        .profile-menu a:hover {
            background: #1ea7d7;
            color: #00141c;
        }

        /* SIDEBAR STYLES */
        .sidebar {
            position: fixed;
            left: -280px;
            top: 0;
            width: 260px;
            height: 100%;
            background: rgba(10, 30, 40, 0.95);
            backdrop-filter: blur(12px);
            border-right: 1px solid #2c5a6e;
            padding: 30px 20px;
            transition: left 0.3s ease;
            z-index: 2000;
            color: #e0f0f5;
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar .close-btn {
            background: none;
            border: none;
            color: #6fe3ff;
            font-size: 28px;
            cursor: pointer;
            margin-bottom: 30px;
        }

        .sidebar ul {
            list-style: none;
        }

        .sidebar ul li {
            margin: 25px 0;
        }

        .sidebar ul li a {
            color: #dffaff;
            text-decoration: none;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.2s;
        }

        .sidebar ul li a:hover {
            color: #6fe3ff;
            transform: translateX(5px);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(2px);
            z-index: 1500;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
        }

        .overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        /* MAIN CONTENT */
        .main-content {
            margin-top: 100px;
            padding: 20px 30px;
            margin-left: 0;
            transition: margin-left 0.3s;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .section-header h1 {
            color: #6fe3ff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-size: 2.2rem;
            font-weight: 400;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: #1ea7d7;
            border: none;
            padding: 12px 28px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1rem;
            color: #00141c;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 8px 16px rgba(0,40,60,0.4);
            border: 1px solid #6fe3ff;
        }

        .btn-primary:hover {
            background: #6fe3ff;
            transform: scale(1.02);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid #6fe3ff;
            padding: 8px 16px;
            border-radius: 30px;
            color: #dffaff;
            cursor: pointer;
            transition: 0.2s;
            font-weight: 500;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #1ea7d7;
            color: #00141c;
        }

        .btn-secondary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            border-color: #607d8b;
        }

        .btn-danger {
            background: transparent;
            border: 1px solid #ff7b7b;
            color: #ffb3b3;
            padding: 8px 16px;
            border-radius: 30px;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c44a4a;
            color: white;
            border-color: #ff7b7b;
        }

        /* Subject cards grid */
        .subjects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .subject-card {
            background: rgba(10, 30, 40, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid #2c5a6e;
            border-radius: 24px;
            padding: 20px;
            color: #e6f7ff;
            box-shadow: 0 10px 20px rgba(0, 20, 30, 0.5);
            transition: 0.2s;
            position: relative;
            cursor: pointer;
        }

        .subject-card:hover {
            border-color: #6fe3ff;
            background: rgba(20, 50, 65, 0.8);
        }

        .card-content h3 {
            font-size: 1.5rem;
            margin-bottom: 8px;
            font-weight: 500;
            padding-right: 30px;
        }

        .card-content p {
            opacity: 0.8;
            font-size: 0.95rem;
        }

        .delete-subject-x {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(220, 70, 70, 0.2);
            border: 1px solid #ff7b7b;
            color: #ffb3b3;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            z-index: 10;
        }

        .delete-subject-x:hover {
            background: #c44a4a;
            color: white;
            border-color: #ff7b7b;
            transform: scale(1.1);
        }

        /* detail panel */
        .detail-panel {
            background: rgba(8, 25, 35, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid #1ea7d7;
            border-radius: 32px;
            padding: 30px;
            margin-top: 40px;
            color: #f0faff;
            box-shadow: 0 20px 30px rgba(0,0,0,0.6);
        }

        .detail-panel h2 {
            color: #6fe3ff;
            margin-bottom: 20px;
            font-size: 2rem;
            font-weight: 400;
            border-bottom: 1px dashed #2c5a6e;
            padding-bottom: 10px;
        }

        .search-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
            flex: 1;
        }

        .input-group label {
            font-size: 0.8rem;
            color: #a0d0e0;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }

        .input-group input, .input-group select {
            background: #1c3f4f;
            border: 1px solid #3b7a94;
            border-radius: 40px;
            padding: 10px 18px;
            color: white;
            font-size: 0.95rem;
            outline: none;
        }

        .input-group input::placeholder {
            color: #9bbaca;
        }

        .student-list {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 24px;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
        }

        .student-item {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(30, 60, 75, 0.6);
            margin: 8px 0;
            padding: 10px 20px;
            border-radius: 40px;
            border: 1px solid #2e5f72;
        }

        .student-item .student-checkbox {
            width: 20px;
            height: 20px;
            accent-color: #1ea7d7;
            cursor: pointer;
        }

        .student-info {
            flex: 1;
            color: #d7f0fa;
        }

        .student-item.enrolled {
            opacity: 0.7;
            background: rgba(20, 50, 60, 0.8);
            border-color: #3f7e8c;
        }

        .enrolled-badge {
            color: #82c5a0;
            font-size: 0.85rem;
            margin-left: 10px;
        }

        .batch-actions {
            display: flex;
            gap: 12px;
            margin: 20px 0 10px;
            flex-wrap: wrap;
        }

        .enrolled-section {
            margin-top: 30px;
        }

        .enrolled-section h3 {
            color: #b3e4ff;
            font-weight: 400;
            border-bottom: 1px solid #2c5a6e;
            padding-bottom: 5px;
        }

        .chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 15px;
        }

        .chip {
            background: #154250;
            border-radius: 40px;
            padding: 8px 20px;
            border: 1px solid #3f92b0;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .chip .remove {
            color: #ff9f9f;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2rem;
            margin-left: 6px;
        }

        .placeholder-text {
            color: #799eb0;
            font-style: italic;
            padding: 15px 0;
        }

        /* Drop button style */
        .drop-btn {
            background: rgba(220, 70, 70, 0.2);
            border: 1px solid #ff7b7b;
            color: #ffb3b3;
            padding: 4px 12px;
            border-radius: 30px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.2s;
            margin-left: 10px;
        }

        .drop-btn:hover {
            background: #c44a4a;
            color: white;
            border-color: #ff7b7b;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #0c2c3a;
            border-radius: 40px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            border: 1px solid #1ea7d7;
            box-shadow: 0 30px 40px rgba(0,0,0,0.7);
        }

        .modal-content h2 {
            color: #6fe3ff;
            margin-bottom: 25px;
            font-weight: 400;
        }

        .modal-content input {
            width: 100%;
            background: #1c3f4f;
            border: 1px solid #3b7a94;
            border-radius: 40px;
            padding: 14px 20px;
            color: white;
            font-size: 1rem;
            margin-bottom: 20px;
            outline: none;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-all {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 15px;
            background: rgba(20, 50, 65, 0.5);
            border-radius: 40px;
            margin-bottom: 15px;
        }

        .checkbox-all input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #1ea7d7;
        }

        .confirm-delete-modal .modal-content {
            text-align: center;
        }

        .confirm-delete-modal p {
            color: #d7f0fa;
            margin: 20px 0 30px;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>

<div id="sidebarContainer"></div>

<nav>
    <button class="menu-btn" onclick="toggleMenu()">☰</button>
    <div class="profile-wrapper">
        <div class="profile" onclick="toggleProfileMenu()">
            <img src="images/profile.png" id="navProfileImage" alt="profile">
        </div>
        <div id="profileMenu" class="profile-menu">
            <a href="teachers_profile.html">Edit Profile</a>
            <a href="#">Settings</a>
            <a href="login.html">Logout</a>
        </div>
    </div>
</nav>

<!-- CREATE SUBJECT MODAL -->
<div id="createSubjectModal" class="modal">
    <div class="modal-content">
        <h2>Create new subject</h2>
        <input type="text" id="subjectNameInput" placeholder="Subject name (e.g. Advanced Mathematics)" autocomplete="off">
        <input type="text" id="subjectCodeInput" placeholder="Subject code (e.g. MATH401)" autocomplete="off">
        <div class="modal-actions">
            <button class="btn-secondary" onclick="closeCreateModal()">Cancel</button>
            <button class="btn-primary" onclick="saveNewSubject()">Create</button>
        </div>
    </div>
</div>

<!-- CONFIRM DELETE SUBJECT MODAL -->
<div id="confirmDeleteModal" class="modal confirm-delete-modal">
    <div class="modal-content">
        <h2>Delete subject</h2>
        <p id="deleteSubjectName">Are you sure you want to delete this subject?</p>
        <div class="modal-actions" style="justify-content: center;">
            <button class="btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            <button class="btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
    </div>
</div>

<!-- MAIN CONTENT -->
<div class="main-content" id="mainContent">
    <div class="section-header">
        <h1>Subjects Records</h1>
        <button class="btn-primary" id="createSubjectBtn">+ Create subject</button>
    </div>

    <div id="subjectsContainer" class="subjects-grid"></div>

    <!-- detail panel -->
    <div id="subjectDetailPanel" class="detail-panel" style="display: none;">
        <h2 id="selectedSubjectTitle">Subject name</h2>
        
        <div class="search-section">
            <div class="input-group">
                <label>Student name</label>
                <input type="text" id="searchName" placeholder="e.g. John Smith" />
            </div>
            <div class="input-group">
                <label>Year</label>
                <select id="searchYear">
                    <option value="">Any year</option>
                    <option value="1">1st year</option>
                    <option value="2">2nd year</option>
                    <option value="3">3rd year</option>
                    <option value="4">4th year</option>
                </select>
            </div>
            <div class="input-group">
                <label>Section</label>
                <select id="searchSection">
                    <option value="">Any section</option>
                    <option value="A">Section A</option>
                    <option value="B">Section B</option>
                    <option value="C">Section C</option>
                    <option value="D">Section D</option>
                </select>
            </div>
            <button class="btn-secondary" id="searchStudentBtn">Search</button>
        </div>

        <!-- batch selection and actions -->
        <div id="batchControls" style="display: none;">
            <div class="checkbox-all">
                <input type="checkbox" id="selectAllCheckbox">
                <label for="selectAllCheckbox" style="color: #d7f0fa;">Select all</label>
            </div>
            <div class="batch-actions">
                <button class="btn-secondary" id="addSelectedBtn" disabled>Add selected</button>
                <button class="btn-danger" id="clearSelectionBtn" disabled>Clear</button>
            </div>
        </div>

        <!-- search results -->
        <div id="studentResults" class="student-list"></div>

        <div class="enrolled-section">
            <h3>Enrolled students</h3>
            <div id="enrolledList" class="chips-container"></div>
        </div>
    </div>
</div>

<script>
    // ---------- PROFILE MENU ----------
    function toggleProfileMenu() {
        document.getElementById('profileMenu').classList.toggle('active');
    }
    window.toggleProfileMenu = toggleProfileMenu;

    // ---------- SIDEBAR ----------
    fetch('teachers_sidebar.html')
        .then(r => r.text())
        .then(html => {
            document.getElementById('sidebarContainer').innerHTML = html;
            initializeSidebar();
        })
        .catch(error => {
            console.error('Error loading sidebar, using fallback');
            const fallbackSidebar = `
                <div class="sidebar" id="sidebar">
                    <button class="close-btn" onclick="toggleMenu()">✕</button>
                    <ul>
                        <li><a href="#">Dashboard</a></li>
                        <li><a href="#">Subjects</a></li>
                        <li><a href="#">Students</a></li>
                        <li><a href="#">Settings</a></li>
                    </ul>
                </div>
                <div class="overlay" id="overlay" onclick="toggleMenu()"></div>
            `;
            document.getElementById('sidebarContainer').innerHTML = fallbackSidebar;
            initializeSidebar();
        });

    function initializeSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        if (sidebar && overlay) {
            window.toggleMenu = function() {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            };
        } else {
            window.toggleMenu = function() { console.warn('sidebar not ready'); };
        }
    }

    // ---------- DATA ----------
    // Expanded student database with random names for testing
    const studentDB = [
        { id: 'st1', name: 'Alice Chen', year: '2', section: 'A' },
        { id: 'st2', name: 'Bob Miller', year: '3', section: 'B' },
        { id: 'st3', name: 'Charlie Rose', year: '1', section: 'C' },
        { id: 'st4', name: 'Diana Prince', year: '4', section: 'A' },
        { id: 'st5', name: 'Ethan Hunt', year: '2', section: 'B' },
        { id: 'st6', name: 'Fiona Glen', year: '3', section: 'C' },
        { id: 'st7', name: 'George King', year: '1', section: 'D' },
        { id: 'st8', name: 'Hannah Lee', year: '4', section: 'B' },
        { id: 'st9', name: 'Ian Wright', year: '2', section: 'A' },
        { id: 'st10', name: 'Jane Eyre', year: '3', section: 'D' },
        { id: 'st11', name: 'Kevin Park', year: '1', section: 'A' },
        { id: 'st12', name: 'Laura Martinez', year: '2', section: 'C' },
        { id: 'st13', name: 'Michael Brown', year: '3', section: 'B' },
        { id: 'st14', name: 'Nina Williams', year: '4', section: 'D' },
        { id: 'st15', name: 'Oscar Davis', year: '1', section: 'B' },
        { id: 'st16', name: 'Patricia Garcia', year: '2', section: 'D' },
        { id: 'st17', name: 'Quentin Taylor', year: '3', section: 'A' },
        { id: 'st18', name: 'Rachel Anderson', year: '4', section: 'C' },
        { id: 'st19', name: 'Samuel Thomas', year: '1', section: 'C' },
        { id: 'st20', name: 'Tina Jackson', year: '2', section: 'B' },
        { id: 'st21', name: 'Ulysses White', year: '3', section: 'D' },
        { id: 'st22', name: 'Victoria Harris', year: '4', section: 'A' },
        { id: 'st23', name: 'William Martin', year: '1', section: 'B' },
        { id: 'st24', name: 'Xena Thompson', year: '2', section: 'C' },
        { id: 'st25', name: 'Yuri Garcia', year: '3', section: 'A' },
        { id: 'st26', name: 'Zoe Martinez', year: '4', section: 'D' },
        { id: 'st27', name: 'Aaron Robinson', year: '1', section: 'A' },
        { id: 'st28', name: 'Brenda Clark', year: '2', section: 'B' },
        { id: 'st29', name: 'Carlos Rodriguez', year: '3', section: 'C' },
        { id: 'st30', name: 'Dana Lewis', year: '4', section: 'D' }
    ];

    // Initialize subjects with some random enrolled students for testing
    let subjects = JSON.parse(localStorage.getItem('prof_subjects')) || (() => {
        // Create subjects with random student enrollments
        const subjects = [
            { id: 's1', name: 'Advanced Mathematics', code: 'MAT401', students: [] },
            { id: 's2', name: 'Data Structures', code: 'CSE202', students: [] },
            { id: 's3', name: 'Digital Electronics', code: 'ECE310', students: [] },
        ];
        
        // Add random students to each subject for testing
        subjects.forEach(sub => {
            // Get random student IDs (between 5-10 students per subject)
            const numStudents = Math.floor(Math.random() * 6) + 5; // 5-10 students
            const shuffled = [...studentDB].sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, numStudents);
            sub.students = selected.map(s => s.id);
        });
        
        return subjects;
    })();

    let currentSubjectId = null;
    let lastSearchResults = [];
    let subjectToDelete = null;

    function persistSubjects() {
        localStorage.setItem('prof_subjects', JSON.stringify(subjects));
    }

    // Render subject cards with X delete button
    function renderSubjectCards() {
        const container = document.getElementById('subjectsContainer');
        container.innerHTML = '';
        subjects.forEach(sub => {
            const card = document.createElement('div');
            card.className = 'subject-card';
            
            // Card content (clickable)
            const contentDiv = document.createElement('div');
            contentDiv.className = 'card-content';
            contentDiv.innerHTML = `<h3>${sub.name}</h3><p>${sub.code || ''}  • ${sub.students.length} enrolled</p>`;
            
            // Delete X button
            const deleteX = document.createElement('div');
            deleteX.className = 'delete-subject-x';
            deleteX.innerHTML = '✕';
            deleteX.addEventListener('click', (e) => {
                e.stopPropagation();
                openDeleteModal(sub.id, sub.name);
            });
            
            card.appendChild(contentDiv);
            card.appendChild(deleteX);
            
            // Open detail on card click (except when clicking X)
            card.addEventListener('click', (e) => {
                if (e.target === deleteX || deleteX.contains(e.target)) return;
                openSubjectDetail(sub.id);
            });
            
            container.appendChild(card);
        });
    }

    // Delete subject
    function deleteSubject(subjectId) {
        subjects = subjects.filter(s => s.id !== subjectId);
        persistSubjects();
        
        if (currentSubjectId === subjectId) {
            document.getElementById('subjectDetailPanel').style.display = 'none';
            currentSubjectId = null;
        }
        
        renderSubjectCards();
        closeDeleteModal();
    }

    // Delete modal functions
    function openDeleteModal(subjectId, subjectName) {
        subjectToDelete = subjectId;
        document.getElementById('deleteSubjectName').textContent = `Are you sure you want to delete "${subjectName}"?`;
        document.getElementById('confirmDeleteModal').classList.add('active');
    }

    function closeDeleteModal() {
        document.getElementById('confirmDeleteModal').classList.remove('active');
        subjectToDelete = null;
    }

    // Open detail
    function openSubjectDetail(subjectId) {
        const subject = subjects.find(s => s.id === subjectId);
        if (!subject) return;
        currentSubjectId = subjectId;
        const panel = document.getElementById('subjectDetailPanel');
        panel.style.display = 'block';
        document.getElementById('selectedSubjectTitle').innerText = `${subject.name} (${subject.code || 'no code'})`;
        
        // Clear search and hide batch controls initially
        document.getElementById('searchName').value = '';
        document.getElementById('searchYear').value = '';
        document.getElementById('searchSection').value = '';
        document.getElementById('studentResults').innerHTML = '';
        document.getElementById('batchControls').style.display = 'none';
        
        renderEnrolledStudents(subject);
    }

    function renderEnrolledStudents(subject) {
        const enrolledDiv = document.getElementById('enrolledList');
        if (!subject.students.length) {
            enrolledDiv.innerHTML = '<div class="placeholder-text">No students enrolled yet.</div>';
            return;
        }
        enrolledDiv.innerHTML = '';
        subject.students.forEach(studentId => {
            const student = studentDB.find(s => s.id === studentId);
            if (!student) return;
            
            // Create chip with drop button
            const chip = document.createElement('span');
            chip.className = 'chip';
            chip.innerHTML = `
                ${student.name} (Y${student.year}-${student.section})
                <button class="drop-btn" data-student-id="${student.id}">Drop</button>
            `;
            
            // Add event listener to drop button
            const dropBtn = chip.querySelector('.drop-btn');
            dropBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                removeStudentFromSubject(subject.id, student.id);
            });
            
            enrolledDiv.appendChild(chip);
        });
    }

    function removeStudentFromSubject(subjectId, studentId) {
        const subject = subjects.find(s => s.id === subjectId);
        if (subject) {
            subject.students = subject.students.filter(id => id !== studentId);
            persistSubjects();
            if (currentSubjectId === subjectId) {
                renderEnrolledStudents(subject);
                renderSubjectCards();
                if (document.getElementById('studentResults').children.length > 0) {
                    searchStudents();
                }
            }
        }
    }

    // Search students
    function searchStudents() {
        if (!currentSubjectId) return;
        const nameQuery = document.getElementById('searchName').value.toLowerCase().trim();
        const year = document.getElementById('searchYear').value;
        const section = document.getElementById('searchSection').value;

        const results = studentDB.filter(s => {
            if (nameQuery && !s.name.toLowerCase().includes(nameQuery)) return false;
            if (year && s.year !== year) return false;
            if (section && s.section !== section) return false;
            return true;
        });

        lastSearchResults = results.map(s => s.id);
        displaySearchResults(results);
    }

    function displaySearchResults(studentsArray) {
        const container = document.getElementById('studentResults');
        const batchControls = document.getElementById('batchControls');
        const subject = subjects.find(s => s.id === currentSubjectId);
        const enrolledIds = subject ? subject.students : [];

        if (studentsArray.length === 0) {
            container.innerHTML = '<div class="placeholder-text">No matching students.</div>';
            batchControls.style.display = 'none';
            return;
        }

        batchControls.style.display = 'block';
        container.innerHTML = '';

        studentsArray.forEach(student => {
            const isEnrolled = enrolledIds.includes(student.id);
            const item = document.createElement('div');
            item.className = `student-item ${isEnrolled ? 'enrolled' : ''}`;
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'student-checkbox';
            checkbox.value = student.id;
            checkbox.disabled = isEnrolled;
            if (isEnrolled) checkbox.checked = false;
            
            const infoSpan = document.createElement('span');
            infoSpan.className = 'student-info';
            infoSpan.textContent = `${student.name} (Year ${student.year} · Sec ${student.section})`;
            
            item.appendChild(checkbox);
            item.appendChild(infoSpan);
            
            if (isEnrolled) {
                const badge = document.createElement('span');
                badge.className = 'enrolled-badge';
                badge.textContent = 'enrolled';
                item.appendChild(badge);
            }
            
            container.appendChild(item);
        });

        updateBatchControls();
    }

    function updateBatchControls() {
        const checkboxes = document.querySelectorAll('#studentResults .student-checkbox:not(:disabled)');
        const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
        const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
        
        document.getElementById('selectAllCheckbox').checked = allChecked;
        document.getElementById('addSelectedBtn').disabled = !anyChecked;
        document.getElementById('clearSelectionBtn').disabled = !anyChecked;
    }

    function selectAll(checked) {
        const checkboxes = document.querySelectorAll('#studentResults .student-checkbox:not(:disabled)');
        checkboxes.forEach(cb => cb.checked = checked);
        updateBatchControls();
    }

    function clearSelection() {
        const checkboxes = document.querySelectorAll('#studentResults .student-checkbox:not(:disabled)');
        checkboxes.forEach(cb => cb.checked = false);
        updateBatchControls();
    }

    function addSelectedStudents() {
        if (!currentSubjectId) return;
        const subject = subjects.find(s => s.id === currentSubjectId);
        if (!subject) return;
        
        const selected = Array.from(document.querySelectorAll('#studentResults .student-checkbox:not(:disabled):checked'))
            .map(cb => cb.value);
        
        if (selected.length === 0) return;
        
        selected.forEach(studentId => {
            if (!subject.students.includes(studentId)) {
                subject.students.push(studentId);
            }
        });
        
        persistSubjects();
        renderEnrolledStudents(subject);
        renderSubjectCards();
        searchStudents();
        clearSelection();
    }

    // Create modal functions
    function openCreateModal() {
        document.getElementById('createSubjectModal').classList.add('active');
        document.getElementById('subjectNameInput').value = '';
        document.getElementById('subjectCodeInput').value = '';
    }

    function closeCreateModal() {
        document.getElementById('createSubjectModal').classList.remove('active');
    }

    function saveNewSubject() {
        const name = document.getElementById('subjectNameInput').value.trim();
        const code = document.getElementById('subjectCodeInput').value.trim();
        if (!name) {
            alert('Subject name is required');
            return;
        }
        const newId = 'subj_' + Date.now() + Math.random().toString(36).substr(2, 5);
        const newSubject = {
            id: newId,
            name: name,
            code: code || '---',
            students: []
        };
        subjects.push(newSubject);
        persistSubjects();
        renderSubjectCards();
        closeCreateModal();
        openSubjectDetail(newId);
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        renderSubjectCards();

        document.getElementById('createSubjectBtn').addEventListener('click', openCreateModal);
        
        document.getElementById('searchStudentBtn').addEventListener('click', (e) => {
            e.preventDefault();
            searchStudents();
        });

        document.getElementById('searchName').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') searchStudents();
        });

        // Batch controls
        document.getElementById('selectAllCheckbox').addEventListener('change', (e) => {
            selectAll(e.target.checked);
        });

        document.getElementById('addSelectedBtn').addEventListener('click', addSelectedStudents);
        document.getElementById('clearSelectionBtn').addEventListener('click', clearSelection);

        // Confirm delete
        document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
            if (subjectToDelete) {
                deleteSubject(subjectToDelete);
            }
        });

        // Close modals on outside click
        window.addEventListener('click', (e) => {
            const createModal = document.getElementById('createSubjectModal');
            const deleteModal = document.getElementById('confirmDeleteModal');
            if (e.target === createModal) closeCreateModal();
            if (e.target === deleteModal) closeDeleteModal();
        });
    });

    // Click outside profile menu
    window.addEventListener('click', function(e) {
        const profileMenu = document.getElementById('profileMenu');
        const profilePic = document.querySelector('.profile');
        if (!profilePic?.contains(e.target) && !profileMenu?.contains(e.target)) {
            profileMenu?.classList.remove('active');
        }
    });

    // Expose functions globally
    window.closeCreateModal = closeCreateModal;
    window.saveNewSubject = saveNewSubject;
    window.closeDeleteModal = closeDeleteModal;
</script>
</body>
</html>